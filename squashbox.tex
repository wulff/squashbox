\documentclass[ebook,10pt,twoside,openright]{memoir}

\usepackage[T1]{fontenc}
%\usepackage[danish]{babel,varioref}
\usepackage[utf8]{inputenc}

% include book-specific macros and settings
\usepackage{squashbox}

% set title page content
\title{SquashBox}
\author{Morten Wulff}
\date{\today}

% add extra options to hyperref if we're generating a pdf
\ifpdf
	\usepackage[pdfauthor={Morten Wulff},%
	            pdftitle={\thetitle},%
	            pdfdisplaydoctitle=true,%
	            hypertexnames=false,%
	            plainpages=false,%
	            pdftex]{hyperref}
\else
	\usepackage{hyperref}
\fi
\usepackage{memhfixc}

\begin{document}

\frontmatter

% create title pages
\squashboxhalftitlepage{\thetitle}
\squashboxtitlepage{A virtual development environment based on VirtualBox, Ubuntu, and NetBeans.}{\thetitle}{}

\include{copyright}

% create toc with no page number on the first page
\begingroup
\aliaspagestyle{chapter}{empty}
\tableofcontents*
\endgroup

% ============================================================================
\chapter{Preface}

\section*{Audience}

This guide assumes that you know your way around your computer. You do not have to be a super user, but it will definitely help if you have tried installing a couple of CMS'es on your local machine or on shared hosting.

% TODO: expand this section

\section*{Conventions used in this guide}

\begingroup
\setlength{\parindent}{0pt}

This guide uses the following typographical conventions:

\begin{description}
\item[\normalfont\emph{Italic}] Indicates file names, folders, module and package names, new terms, and emphasized text.
\item[\normalfont\texttt{Fixed width}] Indicates code, file contents, and terminal output.
\item[\normalfont\textbf{\texttt{Fixed width}}] Indicates commands entered by the user.
\end{description}

Arrows are used to indicate navigation of a web site or application menus:

\vspace{0.5\baselineskip}
\hspace{2\baselineskip}\emph{Structure $\rightarrow$ Content types $\rightarrow$ Add content type}
\vspace{0.5\baselineskip}

This indicates that you should click on the link \emph{Structure}, then on the link \emph{Content types} and finally click on the link \emph{Add content type}.

% TODO: add example for navigating netbeans menus.

\endgroup

\mainmatter

\part{Setting up shop}

% ============================================================================
\chapter{Base system} \label{chbasesystem}
\chapterprecis{Download the latest version of Ubuntu Desktop Edition and install it on a spare computer or a virtual machine.}

\noindent
Before we get started you must decide if you want to install your development system on a physical machine (e.g. that spare laptop you have lying around) or in a virtual machine on your computer.

If you decide to install on a physical machine, you only need to read the sections \emph{Download Ubuntu} on page \ref{secdownloadubuntu} and \emph{Install Ubuntu} on page \ref{secinstallubuntu}.

% ----------------------------------------------------------------------------
\section{Download Ubuntu} \label{secdownloadubuntu}

To get started, you need to download the latest version of the Ubuntu Desktop Edition (currently, this is version 10.10, nicknamed Maverick Meerkat). Go to the Ubuntu site and click the big \emph{Download Ubuntu} button.

\squashboxlink{http://www.ubuntu.com/}

On the download page, simply click the \emph{Start download} button to download the default version of the Desktop Edition.

\squashboxscreenshot{base/downloadubuntu.png}{Download the recommended version of Ubuntu}{figdownloadubuntu}

If you are planning to install Ubuntu on a spare machine or alongside your existing operating system, you should follow the second step of the guide on the download page to either burn a CD or create a USB drive for installing Ubuntu.

% ----------------------------------------------------------------------------
\section{Install VirtualBox} \label{secinstallvirtualbox}

Multiple products are available for setting up virtual machines on your computer, e.g. \hreffoot{http://www.vmware.com/products/fusion/}{VMWare Fusion}, \hreffoot{http://www.vmware.com/products/workstation/}{VMWare Workstation}, and \hreffoot{http://www.parallels.com/eu/computing/}{Parallels Desktop}.

This guide uses the open source VirtualBox products, which is available for Mac OS, Windows, and Linux. Go to the download page and pick the installation package that matches your operating system.

\squashboxlink{http://www.virtualbox.org/wiki/Downloads}

Once you have downloaded the package, you can run it and follow the steps in the installer to setup VirtualBox. This guide does not cover the VirtualBox installation process in detail. Please refer to the documentation on the VirtualBox site.

When VirtualBox is installed, you can execute it and start configuring your first virtual machine.

\squashboxscreenshot{base/virtualboxwelcome.png}{VirtualBox manager}{figvirtualboxwelcome}

In the VirtualBox Manager (see figure \ref{figvirtualboxwelcome}), click the \emph{New} button to start the \emph{Virtual Machine Wizard}. When you click \emph{Continue} on the first page of the wizard, it is time to select which operating system the virtual machine will be running and giving it a memorable name. We'll call the machine \emph{SquashBox} and tell the wizard that it will be running Ubuntu (see figure \ref{figvirtualboxwizardname}).

\squashboxscreenshot{base/virtualboxwizardname.png}{Naming your virtual machine}{figvirtualboxwizardname}

Since this virtual machine will be used for development and debugging, we will assign 1024~MB of memory to it. If you have \emph{lots} of free memory, or if you plan to use the virtual machine as your primary development environment, you can increase this. The wizard indicates how much memory you can safely allocate to the virtual machine (see figure \ref{figvirtualboxwizardmemory}).

\squashboxscreenshot{base/virtualboxwizardmemory.png}{Allocating memory to the virtual machine}{figvirtualboxwizardmemory}

The next step is to create a virtual disk for the virtual machine. Instead of using a physical hard disk in your machine, the virtual machine uses one or more files on your file system to emulate a hard disk. We'll stick with the default settings and create a new hard disk with 8~GB of space (see figure \ref{figvirtualboxwizarddisk}).

\squashboxscreenshot{base/virtualboxwizarddisk.png}{Creating a virtual disk for the virtual machine}{figvirtualboxwizarddisk}

Click \emph{Continue} to open the \emph{Create new virtual disk} wizard. You can choose between fixed-size storage and dynamically expanding storage. We'll choose the dynamic option to make sure that the virtual disk doesn't take up more space than necessary (see figure \ref{figvirtualboxwizarddisktype}).

\squashboxscreenshot{base/virtualboxwizarddisktype.png}{Selecting the hard disk storage type}{figvirtualboxwizarddisktype}

When you have selected a storage type, you can set the size and location of the virtual disk. By default, the virtual disk is placed in the same folder as the virtual machine definition. If you have enough free space on your hard disk you probably don't have to change the locations, but it can be handy if you want to put the virtual disk on another partition or drive (see figure \ref{figvirtualboxwizarddisklocation}). When you have reviewed the settings for the new disk, you can click \emph{Done} to create the disk and exit the wizard.

\squashboxscreenshot{base/virtualboxwizarddisklocation.png}{Selecting the location and size of the virtual disk}{figvirtualboxwizarddisklocation}

Finally, you can review the settings of your new virtual machine and click \emph{Done} in the main wizard to create the machine and exit the wizard.

Before you can boot your shiny new virtual machine, you have to make a few changes to its settings. Click the \emph{Settings} button in the VirtualBox Manager to change the display settings and attach the Ubuntu CD image you downloaded earlier.

Start by clicking the \emph{Display} tab and adding some video memory. We will make 64~MB available to the guest operating system (see figure \ref{figvirtualboxconfiguredisplay}).

\squashboxscreenshot{base/virtualboxconfiguredisplay.png}{Display settings}{figvirtualboxconfiguredisplay}

To be able to boot from the Ubuntu CD image, you must attach it to the virtual machine. Go to the \emph{Storage} tab and select the empty slot beneath the IDE controller. Click the little disk icon next to the attributes dropdown, select \emph{Choose a virtual CD/DVD disk file}, and select the Ubuntu Desktop disk image (see figure \ref{figvirtualboxconfigurestorage}).

\squashboxscreenshot{base/virtualboxconfigurestorage.png}{Storage settings}{figvirtualboxconfigurestorage}

Now you are ready to install Ubuntu Desktop Edition on your virtual machine!

\squashboxscreenshot{base/virtualboxmanager.png}{VirtualBox Manager}{figvirtualboxmanager}

% ----------------------------------------------------------------------------
\section{Install Ubuntu} \label{secinstallubuntu}

To start the installation, select your virtual machine in the VirtualBox Manager (see figure \ref{figvirtualboxmanager}) and click the \emph{Start} button in the toolbar. The virtual machine will boot from the CD image you attached to it in the previous section.

% TODO: or boot from the CD or USB stick

When the machine has finished booting, you will be presented with the Ubuntu installer. Click \emph{Install Ubuntu} to install Ubuntu on your virtual machine (see figure \ref{figubuntuinstaller}).

\squashboxscreenshot{base/ubuntuinstaller.png}{Ubuntu installer}{figubuntuinstaller}

On the next screen, you can confirm that your virtual machine satisfies Ubuntu's requirements. If you are connected to the internet when you are doing the install, you can choose to download all necessary software updates during the installation process (see figure \ref{figubuntupreparing}).

\squashboxscreenshot{base/ubuntupreparing.png}{Preparing to install Ubuntu}{figubuntupreparing}

The next step is to allocate drive space to the Ubuntu installation. Since we are giving over the entire virtual machine to Ubuntu, we will stick to the default and erase the entire virtual disk (see figure \ref{figubuntuallocate}).

\squashboxscreenshot{base/ubuntuallocate.png}{Allocate drive space}{figubuntuallocate}

If you are not having any second thoughts, you can press the \emph{Install Now} button to start the actual installation (see figure \ref{figubuntuinstallnow}).

\squashboxscreenshot{base/ubuntuinstallnow.png}{Start the installation process}{figubuntuinstallnow}

While the installer copies all the files to your virtual hard disk, you must configure your time zone and keyboard layout, and create a user account.

First, you must select your time zone. This will make sure that all dates and times display correctly. You can either perform the selection by clicking on the world map or by entering the name of the nearest major city in the search field below the map (see figure \ref{figubuntulocale}).

\squashboxscreenshot{base/ubuntulocale.png}{Select your locale}{figubuntulocale}

Next, you must select a keyboard layout. Select your country in the list on the left and choose the specific layout in the list on the right (see figure \ref{figubuntukeyboard}). If you are not sure of which keyboard layout your are using, you can click the \emph{Figure out keyboard layout} button. This will opens a wizard which tries to determine your keyboard layout by having you a series of special characters.

\squashboxscreenshot{base/ubuntukeyboard.png}{Select your keyboard layout}{figubuntukeyboard}

Finally, you must create a user account. Enter your full name and, your desired username, and a password. If you are installing Ubuntu on a virtual machine, you can choose the \emph{Log me in automatically} option, to avoid having to enter your username and password every time your boot the machine. If, instead, you are doing the installation on a physical machine, you should use the default option \emph{Require my password to log in} (see figure \ref{figubuntuaccount}).

\squashboxscreenshot{base/ubuntuaccount.png}{Create an account}{figubuntuaccount}

When the installer has finished copying files and configuring the system, it is time to restart the virtual machine and start adding software to it.

The first time you start your machine, the Ubuntu Update Manager will examine your system and install all available updates. This can take a while. Once all updates have been installed you will have to restart your machine.

\squashboxhint{If you are installing on a virtual machine, now would be a good time to detach the Ubuntu Desktop CD image. Go to the VirtualBox Manager and choose \emph{Settings $\rightarrow$ Storage}. Select the Ubuntu CD image, click the small CD icon next to the drive dropdown list and select \emph{Remove disk from virtual drive}.}

% ----------------------------------------------------------------------------
\section{Install VirtualBox tools} \label{secinstallvirtualboxtools}

Once you have restarted your virtual machine and installed all available updates, you should take a few minutes to install the VirtualBox guest additions. These tools provide better integration between the guest operating system and the host operating system.

To install the tools, choose \emph{Devices $\rightarrow$ Install Guest Additions}. This will mount a CD image containing the VirtualBox tools in your Ubuntu machine. Go to \emph{Places $\rightarrow$ VBOXADDITIONS} to open the root of the CD and click the \emph{Open Autorun Prompt} to run the software from the CD. When you click \emph{Run} in the dialog that opens, the install script will install the necessary modules and extensions to integrate Ubuntu with the host system.

When the installation script has finished it job, you should restart the virtual machine to enable the newly installed features.

\squashboxhint{The VirtualBox tools make it easy to acces folders on the host machine from the virtual machine, and makes it easy to change the screen resolution of the virtual machine by simply changing the size of the window it is running in.}

% ============================================================================
\chapter{Servers} \label{chservers}
\chapterprecis{Install a database server and a web server with scripting support.}

\noindent
When the Ubuntu installion is complete and all available updates have been installed, it’s time to install the server software required to run Drupal, WordPress, or other PHP-based software.

We could install all the required software packages manually, but we are going to take advantage of the fact that Ubuntu provides a meta-package which installs the latest stable versions of the Apache web server, the MySQL database server and the PHP scripting language.

Open a terminal window by going to \emph{Applications $\rightarrow$ Accessories $\rightarrow$ Terminal} and run the following command to install Apache, MySQL and PHP:

\begin{squashboxcommand}
sudo apt-get install lamp-server^
\end{squashboxcommand}

When \verb!sudo! asks for a password, simply enter the password you created for your user account when you installed Ubuntu.

Apt-get displays a list of the packages which are about to be installed. Answer yes or press enter to start the installation. Apt-get will then download and install the required packages.
  
As part of the installation process, you will be asked for a password for the MySQL root user. You will need this password to configure the database server later.

Run the following command to install the remaining packages, which are not included in the meta-package:

\begin{squashboxcommand}
sudo apt-get install php5-gd php5-xdebug
\end{squashboxcommand}

This command installs the following packages:

\begin{description}
\item[php5-gd] GD support for PHP
\item[php5-xdebug] Xdebug support for PHP
\end{description}

Note that this version of \verb!php5-gd! uses the system GD library which doesn’t include all the functions which are included in the version of GD which is bundled with PHP. This means that functions like \verb!imagefilter()! and \verb!imagerotate()! will not be available. If you need access to these functions, you can follow this guide to compile your own version of the php5-gd package:

\squashboxlink{http://cumu.li/2008/5/13/recompiling-php5-with-bundled-support-for-gd-on-ubuntu}

\section{Configure Apache}

Enable mod\_expires and mod\_rewrite:

\begin{squashboxcommand}
sudo a2enmod expires rewrite
\end{squashboxcommand}

Restart the Apache server

\begin{squashboxcommand}
sudo /etc/init.d/apache2 restart
\end{squashboxcommand}

\section{Configure MySQL}

Nothing to configure, but take a look at the Mercury project.

Make sure that you can log in to MySQL as the root user:

\begin{squashboxcommand}
mysql -u root -p
\end{squashboxcommand}

Create a squashbox user:

\begin{squashboxcommand}
CREATE USER squashbox@localhost IDENTIFIED BY 'squashbox';
FLUSH PRIVILEGES;
EXIT
\end{squashboxcommand}

You can run the following command to make sure that the new user can log in:

\begin{squashboxcommand}
mysql -usquashbox -psquashbox
\end{squashboxcommand}

\section{Configure PHP}

Edit the /etc/php5/conf.d/xdebug.ini file and add the following lines to it:

\begin{squashboxcommand}
sudo gedit /etc/php5/conf.d/xdebug.ini
\end{squashboxcommand}

\begin{squashboxoutput}
xdebug.remote_enable=on
xdebug.remote_handler=dbgp
xdebug.remote_mode=req
xdebug.remote_host=127.0.0.1
xdebug.remote_port=9000
xdebug.profiler_enable_trigger=1
\end{squashboxoutput}

Restart Apache:

\begin{squashboxcommand}
sudo /etc/init.d/apache2 restart
\end{squashboxcommand}

PHP has a default memory limit of 128 megabytes. You can edit /etc/php/apache2/php.ini and /etc/php/cli/php.ini to up the memory limit for the webserver and CLI repectively.

% ============================================================================
\chapter{Development tools} \label{chdevtools}
\chapterprecis{Install an integrated development environment and a selection of useful browser plugins.}

\section{NetBeans}

\begin{squashboxcommand}
sudo apt-get install netbeans
\end{squashboxcommand}

0 upgraded, 97 newly installed, 0 to remove and 0 not upgraded.
Need to get 175MB of archives.
After this operation, 689MB of additional disk space will be used.

Start NetBeans:

\emph{Applications $\rightarrow$ Programming $\rightarrow$ NetBeans IDE 6.9}

When you start NetBeans, you will be presented with a start page which shows NetBeans related news and blog posts. Uncheck \emph{Show On Startup} if you do not wish to see this page every time you launch NetBeans. You can always access the start page from the Help menu.

Install PHP Plugin:

\emph{Tools $\rightarrow$ Plugins $\rightarrow$ Available Plugins}

Select the PHP plugin on the list and click the \emph{Install} button.

Follow steps in wizard.

When the installation process is finished, you must restart the IDE.

\subsection{Configure NetBeans}

Go to \emph{Tools $\rightarrow$ Options} to configure the global settings. Make the following changes on these tabs:

    * Editor On the Formatting sub-tab set Number of Spaces per Indent to 2 and Tab Size to 2 to match the Drupal code style guidelines.
    * PHP Uncheck the box Stop at the First Line.
    * Miscellaneous On the Files tab you must add a couple of non-standard file extensions used by Drupal. Click New and add the following extensions: install, module, and profile. Set the file type of each extension to PHP (text/x-php5). This enables Find usages and code completion across all Drupal source files.

Go to the Services tab, expand the Databases item and right-click on the MySQL Server at localhost entry and choose \emph{Properties}. If you can’t see the Services tab, go to \emph{Windows $\rightarrow$ Services} to enable it.

Enter the MySQL password you chose when setting up the LAMP stack in the Administrator Password field and check the Save Password box. You are now connected to your local database server. If, for some reason, the connection is dropped, you can right-click on the MySQL Server at localhost entry and choose Connect to reconnect to the server.

\section{Version control}

\begin{squashboxcommand}
sudo apt-get install git gitk git-gui
\end{squashboxcommand}

TODO: insert sample git-config

\section{Firefox plugins}

%    * install firefox plugins

\section{Profiling tools}

Webgrind, Siege and KCachegrind.

\subsection{Webgrind}

Grab the latest copy from GitHub and put it in the /var/www folder.

\begin{squashboxcommand}
sudo git clone git://github.com/jokkedk/webgrind.git /var/www/webgrind
\end{squashboxcommand}

Edit the hosts file

\begin{squashboxcommand}
sudo gedit /etc/hosts
\end{squashboxcommand}

and add the following line to it:

\begin{squashboxoutput}
127.0.0.1   webgrind
\end{squashboxoutput}

Create a new virtual host definition:

\begin{squashboxcommand}
sudo gedit /etc/apache2/sites-available/webgrind
\end{squashboxcommand}

And tell Apache to reload its configuration files

\begin{squashboxcommand}
sudo a2ensite webgrind
\end{squashboxcommand}

Open the \url{http://webgrind/} in your browser to verify that webgrind works.

\subsection{Siege}

\begin{squashboxcommand}
sudo apt-get install siege
\end{squashboxcommand}

% ============================================================================
\chapter{Install Drupal} \label{chinstalldrupal}
\chapterprecis{Install the latest stable and development versions of Drupal.}

\section{Drupal Core}

\section{Drush}

% ============================================================================
\chapter{Caching} \label{chcaching}
\chapterprecis{Install an opcode cache and a reverse proxy server.}

\begin{squashboxcommand}
sudo apt-get install php5-apc memcached varnish
\end{squashboxcommand}

\part{Getting to work}

% ============================================================================
\chapter{Using NetBeans} \label{chusingnetbeans}
\chapterprecis{}

% ============================================================================
\chapter{Debugging} \label{chdebugging}
\chapterprecis{Speed up your development workflow with the installed tools.}

% ============================================================================
\chapter{Performance testing} \label{chperformance}
\chapterprecis{Identify bottlenecks in your application and get an idea of how it performs under simulated loads.}

\section{Profiling with Webgrind}

To start the profiler, simply add \verb!?XDEBUG_PROFILE! to any URL on one of your local sites. The page will load normally, but Xdebug will create a \verb!cachegrind.out! file in the \verb!/tmp! folder.

When the cachegrind file has been written you can go to \url{http://webgrind/} to start analyzing it. In the Webgrind window, you can either just press Update to analyze the latest cachegrind file or select a specific file from the drop down list.

% TODO: Description of the Webgrind interface.

\section{Load testing with Siege}

\end{document}
