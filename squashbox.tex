\documentclass[draft,ebook,10pt,twoside,openright]{memoir}

% use final,ebook,12pt,oneside when generating the e-book version

% uncomment the following commands to print the book on A4 stock
% you may want to add the showtrims class option to include trim marks
%\stockaiv
%\checkandfixthelayout

% TODO: use \textsc for stuff like Apache, MySQL, etc.

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{textcomp}

% include project-specific macros and settings
\usepackage{squashbox}

% set title page content
\title{SquashBox}
\author{Morten Wulff}
\date{\today}

% add extra options to hyperref if we're generating a pdf
% http://en.wikibooks.org/wiki/LaTeX/Hyperlinks
\ifpdf
	\usepackage[%
	  pdfauthor={\theauthor},%
    pdftitle={\thetitle},%
    pdfdisplaydoctitle=true,%
    hypertexnames=false,%
    plainpages=false,%
    colorlinks=true,%
    linkcolor=blue,%
    urlcolor=blue,%
    pdftex]{hyperref}
\else
	\usepackage{hyperref}
%  \usepackage{memhfixc}
\fi

\begin{document}

\frontmatter

% create title pages
\squashboxhalftitlepage{\thetitle}
\squashboxtitlepage{A virtual development environment based on VirtualBox, Ubuntu, and NetBeans.}{\thetitle}{}

\include{copyright}

% create toc with no page number on the first page
\begingroup
\aliaspagestyle{chapter}{empty}
\tableofcontents*
\endgroup

% ============================================================================
\chapter{Preface}

This guide is an expansion and combination of two previous, smaller guides, which were primarily focused on setting up a Drupal development environment.

The scope of this guide has been broadened to cover development and debugging of \textsc{php} applications in general, although it still contains a chapter which focuses on Drupal-specific development tools.

Feedback and suggestions on how to improve this guide are highly appreciated. You can find my e-mail address at the top of the copyright page.

% TODO: expand this section

% ----------------------------------------------------------------------------
\section*{Audience}

This guide assumes that you know your way around your computer and that you have some experience developing software in \textsc{php}. You do not have to be a super user or a professional programmer, but it will definitely help if you have tried installing a couple of different content management systems on your local machine or on shared hosting.

% TODO: expand this section

% ----------------------------------------------------------------------------
\section*{Conventions used in this guide}

\begingroup
\setlength{\parindent}{0pt}

This guide uses the following typographical conventions:

\begin{squashboxsnugshade}
\begin{description}
\item[\normalfont\emph{Italic}] Indicates file names, folders, module and package names, new terms, and emphasized text.
\item[\normalfont\texttt{Fixed width}] Indicates code, file contents, and terminal output.
\item[\normalfont\textbf{\texttt{Fixed width}}] Indicates commands that you enter in the terminal to install packages, restart services, etc.
\end{description}
\end{squashboxsnugshade}

Arrows are used to indicate navigation of a web site or application menus:

\begin{squashboxsnugshade}
\emph{Structure $\rightarrow$ Content types $\rightarrow$ Add content type}
\end{squashboxsnugshade}

This indicates that you should click on the link \emph{Structure}, then on the link \emph{Content types} and finally click on the link \emph{Add content type}.

% TODO: add example for navigating netbeans menus

\endgroup

Some of the commands you have to enter in the terminal are too long to fit on a single line in this guide. In those cases, a backslash is used to indicate that the line has been broken into two or more parts, like in the following example:

% TODO: explain use of \ in commands and output
\begin{squashboxcommand}
sudo apt-get install php5-apc memcached \
  varnish
\end{squashboxcommand}

\noindent
You can either enter the command exactly as it appears in the guide (with a linebreak after the backslash) or ignore the backslash and enter the entire command on one line.

% ----------------------------------------------------------------------------
\section*{Similar projects}

\subsection*{TurnKey \textsc{lamp} Stack Appliance}

The TurnKey appliance is preconfigured to run the Apache web server, the MySQL database server, as well as the \textsc{php}, Python, and Perl scripting languages.

\squashboxlink{http://www.turnkeylinux.org/lamp}

You can either run it in a virtual machine, install it as the only operating system on a computer, or deploy it to the Amazon \textsc{ec2} cloud.

The appliance contains web-based tools for easy administration of Apache and MySQL, making it a good starting point for learning about configuring and using the \textsc{LAMP} stack.

In addition to the \textsc{lamp} appliance, TurnKey Linux provides ready-to-run appliances for running popular content management systems like Drupal, Joomla, or WordPress as well as file, backup, and mail servers. Go to following URL to see the complete list of available appliances:

\squashboxlink{http://www.turnkeylinux.org/all}

\subsection*{Drupal Quickstart}

Drupal Quickstart is a pre-packaged \textsc{php} development environment which is available as a VirtualBox appliance or as a set of scripts for setting up the environment on a clean Ubuntu install.

\squashboxlink{http://drupal.org/project/quickstart}

Even though this project is aimed at Drupal developers, you can use it to develop any kind of \textsc{php}-based software (although you may not be able to use the included utility scripts without modifications).

\mainmatter

\part{Setting up shop}

% ============================================================================
\chapter{Base system} \label{chbasesystem}
\chapterprecis{Download the latest version of the Desktop Edition of Ubuntu, and install it on a spare computer or a virtual machine.}

\noindent
Before we get started you must decide if you want to install your development system on a physical machine (e.g. that spare laptop you have lying around) or in a virtual machine on your computer.

If you decide to install on a physical machine, you only need to read the sections \emph{Download Ubuntu} on page \ref{secdownloadubuntu} and \emph{Install Ubuntu} on page \ref{secinstallubuntu}.

% ----------------------------------------------------------------------------
\section{Download Ubuntu} \label{secdownloadubuntu}

To get started, you need to download the latest version of the Ubuntu Desktop Edition (currently, this is version 10.10, nicknamed Maverick Meerkat). Go to the Ubuntu site and click the big \emph{Download Ubuntu} button.

\squashboxlink{http://www.ubuntu.com/}

On the download page, simply click the \emph{Start download} button to download the default version of the Desktop Edition.

\squashboxscreenshot{base/downloadubuntu.png}{Download the recommended version of Ubuntu}{figdownloadubuntu}

If you are planning to install Ubuntu on a spare machine or alongside your existing operating system, you should follow the second step of the guide on the download page to either burn a \textsc{cd} or create a \textsc{usb} drive for installing Ubuntu.

% ----------------------------------------------------------------------------
\section{Install VirtualBox} \label{secinstallvirtualbox}

Multiple products are available for setting up virtual machines on your computer, e.g. \hreffoot{http://www.vmware.com/products/fusion/}{VMWare Fusion}, \hreffoot{http://www.vmware.com/products/workstation/}{VMWare Workstation}, and \hreffoot{http://www.parallels.com/eu/computing/}{Parallels Desktop}.

This guide uses the open source VirtualBox package, which is available for Mac OS, Windows, and Linux. Go to the download page and pick the installation package that matches your operating system.

\squashboxlink{http://www.virtualbox.org/wiki/Downloads}

Once you have downloaded the package, you can run it and follow the steps in the installer to setup VirtualBox. This guide does not cover the VirtualBox installation process in detail. Please refer to the documentation on the VirtualBox site.

When VirtualBox is installed, you can execute it and start configuring your first virtual machine.

\squashboxscreenshot{base/virtualboxwelcome.png}{VirtualBox manager}{figvirtualboxwelcome}

In the VirtualBox Manager (see figure \ref{figvirtualboxwelcome}), click the \emph{New} button to start the \emph{Virtual Machine Wizard}. When you click \emph{Continue} on the first page of the wizard, it is time to select which operating system the virtual machine will be running and giving it a memorable name. We will call the machine \emph{SquashBox} and tell the wizard that it will be running Ubuntu (see figure \ref{figvirtualboxwizardname}).

\squashboxscreenshot{base/virtualboxwizardname.png}{Naming your virtual machine}{figvirtualboxwizardname}

Since this virtual machine will be used for development and debugging, we will assign 1024~\textsc{mb} of memory to it. If you have \emph{lots} of free memory, or if you plan to use the virtual machine as your primary development environment, you can increase this. The wizard indicates how much memory you can safely allocate to the virtual machine (see figure \ref{figvirtualboxwizardmemory}).

\squashboxscreenshot{base/virtualboxwizardmemory.png}{Allocating memory to the virtual machine}{figvirtualboxwizardmemory}

The next step is to create a virtual disk for the virtual machine. Instead of using a physical hard disk in your machine, the virtual machine uses one or more files on your file system to emulate a hard disk. We will stick with the default settings and create a new hard disk with 8~\textsc{gb} of space (see figure \ref{figvirtualboxwizarddisk}).

\squashboxscreenshot{base/virtualboxwizarddisk.png}{Creating a virtual disk for the virtual machine}{figvirtualboxwizarddisk}

Click \emph{Continue} to open the \emph{Create new virtual disk} wizard. You can choose between fixed-size storage and dynamically expanding storage. We will choose the dynamic option to make sure that the virtual disk does not take up more space than necessary (see figure \ref{figvirtualboxwizarddisktype}).

\squashboxscreenshot{base/virtualboxwizarddisktype.png}{Selecting the hard disk storage type}{figvirtualboxwizarddisktype}

When you have selected a storage type, you can set the size and location of the virtual disk. By default, the virtual disk is placed in the same folder as the virtual machine definition. If you have enough free space on your hard disk you probably do not have to change the locations, but it can be handy if you want to put the virtual disk on another partition or drive (see figure \ref{figvirtualboxwizarddisklocation}). When you have reviewed the settings for the new disk, you can click \emph{Done} to create the disk and exit the wizard.

\squashboxscreenshot{base/virtualboxwizarddisklocation.png}{Selecting the location and size of the virtual disk}{figvirtualboxwizarddisklocation}

Finally, you can review the settings of your new virtual machine and click \emph{Done} in the main wizard to create the machine and exit the wizard.

Before you can boot your shiny new virtual machine, you have to make a few changes to its settings. Click the \emph{Settings} button in the VirtualBox Manager to change the display settings and attach the Ubuntu \textsc{cd} image you downloaded earlier.

Start by clicking the \emph{Display} tab and adding some video memory. We will make 64~\textsc{mb} available to the guest operating system (see figure \ref{figvirtualboxconfiguredisplay}).

\squashboxscreenshot{base/virtualboxconfiguredisplay.png}{Display settings}{figvirtualboxconfiguredisplay}

To be able to boot from the Ubuntu \textsc{cd} image, you must attach it to the virtual machine. Go to the \emph{Storage} tab and select the empty slot beneath the \textsc{ide} controller. Click the little disk icon next to the attributes dropdown, select \emph{Choose a virtual \textscsl{cd/dvd} disk file}, and select the Ubuntu Desktop disk image (see figure \ref{figvirtualboxconfigurestorage}).

\squashboxscreenshot{base/virtualboxconfigurestorage.png}{Storage settings}{figvirtualboxconfigurestorage}

Now you are ready to install Ubuntu Desktop Edition on your virtual machine!

\squashboxscreenshot{base/virtualboxmanager.png}{VirtualBox Manager}{figvirtualboxmanager}

% ----------------------------------------------------------------------------
\section{Install Ubuntu} \label{secinstallubuntu}

To start the installation, select your virtual machine in the VirtualBox Manager (see figure \ref{figvirtualboxmanager}) and click the \emph{Start} button in the toolbar. The virtual machine will boot from the \textsc{cd} image you attached to it in the previous section.

% TODO: or boot from the CD or USB stick

When the machine has finished booting, you will be presented with the Ubuntu installer. Click \emph{Install Ubuntu} to install Ubuntu on your virtual machine (see figure \ref{figubuntuinstaller}).

\squashboxscreenshot{base/ubuntuinstaller.png}{Ubuntu installer}{figubuntuinstaller}

On the next screen, you can confirm that your virtual machine satisfies Ubuntu's requirements. If you are connected to the internet when you are doing the install, you can choose to download all necessary software updates during the installation process (see figure \ref{figubuntupreparing}).

\squashboxscreenshot{base/ubuntupreparing.png}{Preparing to install Ubuntu}{figubuntupreparing}

The next step is to allocate drive space to the Ubuntu installation. Since we are giving over the entire virtual machine to Ubuntu, we will stick to the default and erase the entire virtual disk (see figure \ref{figubuntuallocate}).

\squashboxscreenshot{base/ubuntuallocate.png}{Allocate drive space}{figubuntuallocate}

If you are not having any second thoughts, you can press the \emph{Install Now} button to start the actual installation (see figure \ref{figubuntuinstallnow}).

\squashboxscreenshot{base/ubuntuinstallnow.png}{Start the installation process}{figubuntuinstallnow}

While the installer copies all the files to your virtual hard disk, you must configure your time zone and keyboard layout, and create a user account.

First, you must select your time zone. This will make sure that all dates and times display correctly. You can either perform the selection by clicking on the world map or by entering the name of the nearest major city in the search field below the map (see figure \ref{figubuntulocale}).

\squashboxscreenshot{base/ubuntulocale.png}{Select your locale}{figubuntulocale}

Next, you must select a keyboard layout. Select your country in the list on the left and choose the specific layout in the list on the right (see figure \ref{figubuntukeyboard}). If you are not sure of which keyboard layout your are using, you can click the \emph{Figure out keyboard layout} button. This will opens a wizard which tries to determine your keyboard layout by having you a series of special characters.

\squashboxscreenshot{base/ubuntukeyboard.png}{Select your keyboard layout}{figubuntukeyboard}

Finally, you must create a user account. Enter your full name and, your desired username, and a password. If you are installing Ubuntu on a virtual machine, you can choose the \emph{Log me in automatically} option, to avoid having to enter your username and password every time your boot the machine. If, instead, you are doing the installation on a physical machine, you should use the default option \emph{Require my password to log in} (see figure \ref{figubuntuaccount}).

\squashboxscreenshot{base/ubuntuaccount.png}{Create an account}{figubuntuaccount}

When the installer has finished copying files and configuring the system, it is time to restart the virtual machine and start adding software to it.

The first time you start your machine, the Ubuntu Update Manager will examine your system and install all available updates. This can take a while. Once all updates have been installed you will have to restart your machine.

\squashboxhint{If you are installing on a virtual machine, now would be a good time to detach the Ubuntu Desktop \textsc{cd} image. Go to the VirtualBox Manager and choose \emph{Settings $\rightarrow$ Storage}. Select the Ubuntu \textsc{cd} image, click the small \textsc{cd} icon next to the drive dropdown list and select \emph{Remove disk from virtual drive}.}

% ----------------------------------------------------------------------------
\section{Install VirtualBox tools} \label{secinstallvirtualboxtools}

Once you have restarted your virtual machine and installed all available updates, you should take a few minutes to install the VirtualBox guest additions. These tools provide better integration between the guest operating system and the host operating system.

To install the tools, choose \emph{Devices $\rightarrow$ Install Guest Additions}. This will mount a \textsc{cd} image containing the VirtualBox tools in your Ubuntu machine. Go to \emph{Places $\rightarrow$ VBOXADDITIONS} to open the root of the \textsc{cd} and click the \emph{Open Autorun Prompt} to run the software from the \textsc{cd}. When you click \emph{Run} in the dialog that opens, the install script will install the necessary modules and extensions to integrate Ubuntu with the host system.

When the installation script has finished it job, you should restart the virtual machine to enable the newly installed features.

\squashboxhint{The VirtualBox tools make it easy to acces folders on the host machine from the virtual machine, and makes it easy to change the screen resolution of the virtual machine by simply changing the size of the window it is running in.}

% ============================================================================
\chapter{Servers} \label{chservers}
\chapterprecis{Install a database server and a web server with support for the PHP scripting language.}

\noindent
When the Ubuntu installion is complete and all available updates have been installed, it’s time to install the server software required to run Drupal, WordPress, or other \textsc{php}-based software.

We could install all the required software packages manually, but we are going to take advantage of the fact that Ubuntu provides a meta-package which installs the latest stable versions of the Apache web server, the MySQL database server and the \textsc{php} scripting language.

Open a terminal window by going to \emph{Applications $\rightarrow$ Accessories $\rightarrow$ Terminal} and run the following command to install Apache, MySQL and \textsc{php}:

\begin{squashboxcommand}
sudo apt-get install lamp-server^
\end{squashboxcommand}

When \verb!sudo! asks for a password, simply enter the password you created for your user account when you installed Ubuntu.

Apt-get displays a list of the packages which are about to be installed. Answer yes or press enter to start the installation. Apt-get will then download and install the required packages.

As part of the installation process, you will be asked for a password for the MySQL root user. You will need this password to configure the database server later.

Run the following command to install the remaining packages, which are not included in the meta-package:

\begin{squashboxcommand}
sudo apt-get install php5-gd php5-xdebug
\end{squashboxcommand}

This command installs the following packages:

\begin{description}
\item[php5-gd] GD support for \textsc{php}
\item[php5-xdebug] Xdebug support for \textsc{php}
\end{description}

Note that this version of \verb!php5-gd! uses the system \textsc{gd} library which does not include all the functions which are included in the version of \textsc{gd} which is bundled with \textsc{php}. This means that functions like \verb!imagefilter()! and \verb!imagerotate()! will not be available. If you need access to these functions, you can follow this guide to compile your own version of the \verb!php5-gd! package:

\squashboxlink{http://cumu.li/2008/5/13/recompiling-php5-with-bundled-support-for-gd-on-ubuntu}

% ----------------------------------------------------------------------------
\section{Configure Apache}

Enable mod\_expires and mod\_rewrite:

\begin{squashboxcommand}
sudo a2enmod expires rewrite
\end{squashboxcommand}

Restart the Apache server

\begin{squashboxcommand}
sudo /etc/init.d/apache2 restart
\end{squashboxcommand}

% ----------------------------------------------------------------------------
\section{Configure MySQL}

Nothing to configure, but take a look at the Mercury project.

Make sure that you can log in to MySQL as the root user:

\begin{squashboxcommand}
mysql -u root -p
\end{squashboxcommand}

Create a squashbox user:

\begin{squashboxcommand}
CREATE USER squashbox@localhost \
  IDENTIFIED BY 'squashbox';
FLUSH PRIVILEGES;
EXIT
\end{squashboxcommand}

You can run the following command to make sure that the new user can log in:

\begin{squashboxcommand}
mysql -usquashbox -psquashbox
\end{squashboxcommand}

% ----------------------------------------------------------------------------
\section{Configure \textsc{php}}

\subsection{Xdebug}

Xdebug lets you step through your code line by line, inspecting variables and the call stack as you go. This makes identifying problems faster than having to rely on printed debug statements or log files.

Before you can use Xdebug to debug and profile your code, you have to modify the configuration slightly. Open a terminal window and run the following command to open the \verb!xdebug.ini! file in a text editor:

\begin{squashboxcommand}
sudo gedit /etc/php5/conf.d/xdebug.ini
\end{squashboxcommand}

Add the following settings to the file:

\begin{squashboxoutput}
xdebug.remote_enable=on
xdebug.remote_handler=dbgp
xdebug.remote_mode=req
xdebug.remote_host=127.0.0.1
xdebug.remote_port=9000
xdebug.profiler_enable_trigger=1
\end{squashboxoutput}

% TODO: describe the options

When you have saved the file you must run the following command to restart Apache:

\begin{squashboxcommand}
sudo /etc/init.d/apache2 restart
\end{squashboxcommand}

PHP has a default memory limit of 128 megabytes. You can edit /etc/php/apache2/php.ini and /etc/php/cli/php.ini to up the memory limit for the webserver and CLI repectively.

% ============================================================================
\chapter{Development tools} \label{chdevtools}
\chapterprecis{Install an integrated development environment and a selection of useful browser plugins.}

% ----------------------------------------------------------------------------
\section{NetBeans}

\begin{squashboxcommand}
sudo apt-get install netbeans
\end{squashboxcommand}

0 upgraded, 97 newly installed, 0 to remove and 0 not upgraded.
Need to get 175MB of archives.
After this operation, 689MB of additional disk space will be used.

Start NetBeans:

\emph{Applications $\rightarrow$ Programming $\rightarrow$ NetBeans IDE 6.9}

When you start NetBeans, you will be presented with a start page which shows NetBeans related news and blog posts. Uncheck \emph{Show On Startup} if you do not wish to see this page every time you launch NetBeans. You can always access the start page from the Help menu.

Install PHP Plugin:

\emph{Tools $\rightarrow$ Plugins $\rightarrow$ Available Plugins}

Select the PHP plugin on the list and click the \emph{Install} button.

Follow steps in wizard.

When the installation process is finished, you must restart the IDE.

\subsection{Configure NetBeans}

Go to \emph{Tools $\rightarrow$ Options} to configure the global settings. Make the following changes on these tabs:

    * Editor On the Formatting sub-tab set Number of Spaces per Indent to 2 and Tab Size to 2 to match the Drupal code style guidelines.
    * PHP Uncheck the box Stop at the First Line.
    * Miscellaneous On the Files tab you must add a couple of non-standard file extensions used by Drupal. Click New and add the following extensions: install, module, and profile. Set the file type of each extension to PHP (text/x-php5). This enables Find usages and code completion across all Drupal source files.

Go to the Services tab, expand the Databases item and right-click on the MySQL Server at localhost entry and choose \emph{Properties}. If you can’t see the Services tab, go to \emph{Windows $\rightarrow$ Services} to enable it.

Enter the MySQL password you chose when setting up the LAMP stack in the Administrator Password field and check the Save Password box. You are now connected to your local database server. If, for some reason, the connection is dropped, you can right-click on the MySQL Server at localhost entry and choose Connect to reconnect to the server.

% ----------------------------------------------------------------------------
\section{Git}

\begin{squashboxcommand}
sudo apt-get install git gitk git-gui
\end{squashboxcommand}

\begin{squashboxoutput}
[color]
ui = auto

[color "diff"]
meta = cyan
frag = yellow

[core]
whitespace = fix, -indent-with-non-tab, \
  -indent-with-tab, trailing-space, cr-at-eol

[push]
default = tracking

[alias]
co = checkout
ci = commit
st = status
br = branch
w = whatchanged
type = cat-file -t
dump = cat-file -p
\end{squashboxoutput}

%lg = log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr)%Creset' --abbrev-commit --date=relative
%hist = log --pretty=format:\"%h %ad | %s%d [%an]\" --graph --date=short

% http://www.turnkeylinux.org/revision-control

% ----------------------------------------------------------------------------
\section{Firefox plugins}

%    * install firefox plugins

% ----------------------------------------------------------------------------
\section{Webgrind}

In order to analyze the output files generated by the Xdebug profiler, you must install Webgrind or KCachegrind. This section helps you install both tools so you can decide which on fits your way of working.

First we have to get the latest copy of Webgrind. Since it is hosted on \hreffoot{https://github.com/}{GitHub} we can simply clone the repository to a folder in \verb!/var/www!.

\begin{squashboxcommand}
sudo git clone git://github.com/jokkedk/webgrind.git /var/www/webgrind
\end{squashboxcommand}

Next, we’ll add a hostname for the local webgrind installation. Open a terminal window and run the following command to open the hosts file in a text editor:

\begin{squashboxcommand}
sudo gedit /etc/hosts
\end{squashboxcommand}

Then, add an entry for webgrind and point it at the local web server on 127.0.0.1:

\begin{squashboxoutput}
127.0.0.1   webgrind
\end{squashboxoutput}

Finally, we have to create a new Apache virtual host to handle requests to \url{http://webgrind/}. Open a terminal window and run the following command to create a new virtual host definition:

\begin{squashboxcommand}
sudo gedit /etc/apache2/sites-available/webgrind
\end{squashboxcommand}

It is a good idea to use the hostname as the name of the virtual host file. This makes it easier to manage a lot of virtual hosts.

Enter the following virtual host definition and save the file:

\begin{squashboxoutput}
% TODO: insert actial vhost configuration
\end{squashboxoutput}

When you have saved the file, you must run the following commands in a terminal window to enable the new virtual host and reload the Apache configuration files:

\begin{squashboxcommand}
sudo a2ensite webgrind
sudo /etc/init.d/apache2 reload
\end{squashboxcommand}

Open the \url{http://webgrind/} in your browser to verify that webgrind works.

  To get nice call-graphs, you need to install the package:

\begin{squashboxcommand}
sudo apt-get install graphviz
\end{squashboxcommand}

And change the webgrind configuration file to point at the dot executable:

\begin{squashboxoutput}
$dotExecutable = "/usr/bin/dot";
$
\end{squashboxoutput}

% TODO: KCacheGrind?

% ----------------------------------------------------------------------------
\section{XHProf}

Install and configure XHProf.

% ----------------------------------------------------------------------------
\section{Siege}

\begin{squashboxcommand}
sudo apt-get install siege
\end{squashboxcommand}

% ============================================================================
\chapter{Install Drupal} \label{chinstalldrupal}
\chapterprecis{Install the latest stable and development versions of Drupal.}

% ----------------------------------------------------------------------------
\section{Drupal Core}

% ----------------------------------------------------------------------------
\section{Drush}

% ============================================================================
\chapter{Caching} \label{chcaching}
\chapterprecis{Install an opcode cache and a reverse proxy server.}

\begin{squashboxcommand}
sudo apt-get install php5-apc memcached varnish
\end{squashboxcommand}

\part{Getting to work}

% ============================================================================
\chapter{Using NetBeans} \label{chusingnetbeans}
\chapterprecis{}

If you haven’t changed any settings, NetBeans will show the following windows on startup:

% TODO: consolidate the two window lists

\begin{itemize}
\item The main editor
\item Projects
\item Files
\item Services
\item Navigator
\item Tasks
\end{itemize}

You can find add more windows by going to the Window menu. We will cover a couple of these windows in the Xdebug section.

\begin{itemize}
\item The \emph{Projects} window shows a list of all your NetBeans projects. You can use it to browse the source of all your projects in one place and to see the include paths for different projects (by default all new projects use the global PHP include path).
\item The \emph{Files} window shows all source files in the active project.
\item The \emph{Services} window gives you easy access to local database servers, web services, and issue trackers.
\item The \emph{Navigator} window shows a list of all the functions in the active file. You can double-click any function name to jump directly to the first line of a function in the editor window.
\item The \emph{Tasks} window gives you an overview of all syntax errors, warnings, and todo items. By default, all occurences of the strings \verb!TODO!, \verb!FIXME!, \verb!XXX!, and \verb!PENDING! are added to the task list. Go to \emph{Tools $\rightarrow$ Options $\rightarrow$ Miscellaneous $\rightarrow$ Tasks} to add your own string patterns.
\end{itemize}

% ----------------------------------------------------------------------------
\section{Code completion}

NetBeans makes developing for Drupal easier because it offers code completion of all built-in PHP functions and all functions defined in your current project. This way you have the full Drupal API and its documentation at your fingertips without having to consult \url{http://api.drupal.org/} every time you want to check the exact behavior of a function.

You can try it out for yourself by creating a new PHP file in the root of your Drupal folder. Right-click on the root folder (in this case, it’s called drupal-6.14) and choose \emph{New $\rightarrow$ PHP file}.

If you place the cursor on an empty line and press \verb!CTRL+SPACE!, NetBeans opens a popup listing all global variables and constants. Start typing to narrow down the list or use the arrow keys to choose the variable you want to insert. Press \verb!enter! to insert the variable name at the current cursor position.

Start typing the first few characters of the PHP function \verb!str_replace! and press \verb!CTRL+SPACE! after you have typed str. NetBeans opens two popups: One showing a list of matching function names and a second showing the documentation for the currently selected function. Type more characters to narrow your search or use the arrow keys to choose the function you want to insert. Press \verb!enter! to insert the function name at the current cursor position.

This works for Druapl API functions and functions from contributed modules as well. Try typing dru and then press \verb!CTRL+SPACE! to show a list of all matching functions.

% ----------------------------------------------------------------------------
\section{Variable highlighting}

Another useful feature is variable highlighting. Open the file bootstrap.inc in the includes folder and jump to the function \verb!drupal_bootstrap()! by double-clicking it in the \emph{Navigator} window. If you place the cursor somewhere in the first occurence of the variable \verb!$phase_index!, NetBeans automatically highlights all four occurences of that variable in the function. This is useful when you are trying to determine whether a local variable is still in use, or to figure out which role a variable plays in a function.

% ----------------------------------------------------------------------------
\section{Navigation}

Sometimes it’s nice to see where a certain function is defined. This is easy to do in NetBeans by using \emph{Go to Declaration}.

Open \verb!index.php! in the root of the Drupal folder and place the cursor somewhere in the function name \verb!menu_execute_active_handler()! on line 18. (Choose \emph{View $\rightarrow$ Show Line Numbers} to enable line numbers in the editor.) Right-click the function name and select \emph{Navigate $\rightarrow$ Go to Declaration} or press \verb!CTRL+B!. NetBeans now opens the file \verb!menu.inc! where the function is defined.

This example also shows a variation of the variable highlighting mentioned above. If you place the cursor at the beginning of a function name, NetBeans automatically highlights all return statements in the function.

Another useful way of navigating your code is to figure out which functions are calling a given function. Return to index.php in the editor and place the cursor somewhere in the function name \verb!menu_execute_active_handler()!. Right-click the function name and select \emph{Find Usages} or press \verb!ALT+F7!. When you click Find in the dialog, NetBeans opens the Usages window and shows a list of all the calls to the selected function.

% TODO: Add information on code folding.

% ----------------------------------------------------------------------------
\section{Debugging}

Now that the Xdebug PHP module has been configured, we can use NetBeans to step through the code as it is being executed by the Apache PHP module.

First, we need to mark the line of code where we would like execution to stop. This is called a breakpoint.

We’ll try to step through the Drupal bootstrap process, so start by opening the file includes/bootstrap.inc. Double-click the function \verb!drupal_bootstrap()! in the \emph{Navigator} to jump to line 983 in the file. Place the cursor in the first line of the function and click the line number (line 984) or press \verb!CTRL+F8! to set a breakpoint (Choose \emph{View $\rightarrow$ Show Line Numbers} to enable line numbers in the editor window).

Choose \emph{Debug $\rightarrow$ Debug Project} or press \verb!CTRL+F5! to start a debugging session. The first time you do this, NetBeans displays a dialog where you can configure some general debugging options. Choose Server side PHP and tell NetBeans not to show the dialog again.

NetBeans will open the front page of your site in FireFox and stop at the first breakpoint it encounters. If you return to the NetBeans window you will see a small green arrow next to the line which is about to be executed.

Also, NetBeans automatically opens four windows below the editor windows: Watches, Variables, Call Stack, and Breakpoints. In the Variables window you can see a list of all the variables which are currently in scope as well as all the PHP superglobals. The Call Stack window displays the current call stack, and the Breakpoints windows displays a list of all breakpoints.

\subsection{Keyboard shortcuts}

Use the following shortcuts to step through the code when running under the debugger:

F5 	Continue 	Runs until the next breakpoint or until the code exits, whichever comes first
F8 	Step over 	Steps through the code one line at a time, but doesn’t enter any functions it encounters
F7 	Step into 	Like step over, but steps into any functions it encounters
CTRL+F7 	Step out 	Steps out of a function which has previously been stepped into
F4 	Run to cursor 	Runs until the current line of execution is on the same line as a cursor (this is useful to skip past big blocks of uninteresting code)

% ============================================================================
\chapter{Debugging} \label{chdebugging}
\chapterprecis{Speed up your development workflow with the installed tools.}

% ============================================================================
\chapter{Performance testing} \label{chperformance}
\chapterprecis{Identify bottlenecks in your application and get an idea of how it performs under simulated loads.}

% ----------------------------------------------------------------------------
\section{Profiling with Webgrind}

In addition to doing step through debugging, you can also use Xdebug to profile your code. Profiling your code lets you see which functions use most of the execution time, making it easy to spot candidates for optimization.

To start the profiler, simply add \verb!?XDEBUG_PROFILE! to any URL on one of your local sites. The page will load normally, but Xdebug will create a \verb!cachegrind.out! file in the \verb!/tmp! folder.

When the cachegrind file has been written you can go to \url{http://webgrind/} to start analyzing it. In the Webgrind window, you can either just press Update to analyze the latest cachegrind file or select a specific file from the drop down list.

% TODO: Description of the Webgrind interface.

% ----------------------------------------------------------------------------
\section{Profiling with XHProf}

\subsection{Profiling from Drupal}

% ----------------------------------------------------------------------------
\section{Load testing with Siege}

\end{document}
